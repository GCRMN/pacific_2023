---
title: "Untitled"
output: html_document
date: "2023-03-24"
---

# Load package

```{r}

# 1. Load packages ----

library(tidyverse) # Core tidyverse packages
library(caret)
library(xgboost)
library(pdp)
library(furrr)
library(future)
library(formattable)
library(DT)

# 2. Load data ----

load("../data/04_data-benthic.RData")
load("../data/12_grid-coral-reef-extent.RData")

# 3. Associate grid weight to each site ----

data_selected <- data_benthic %>% 
  select(decimalLatitude, decimalLongitude) %>% 
  distinct()

data_selected2 <- data_selected %>% 
  st_as_sf(crs = 4326, coords = c("decimalLongitude", "decimalLatitude")) %>% 
  st_intersection(., data_grid %>% select(weight)) %>% 
  mutate(decimalLongitude = st_coordinates(.)[,"X"],
         decimalLatitude = st_coordinates(.)[,"Y"]) %>% 
  st_drop_geometry()

data_selected3 <- left_join(data_selected, data_selected2)

data_benthic <- left_join(data_benthic, data_selected3)

rm(data_selected, data_selected2, data_selected3)

```

# Create function for territory

```{r}

xgboost_territory <- function(xgb_model, data_selected, territory_i){
  
  results <- pdp::partial(object = xgb_model,
                          pred.var = "year",
                          pred.grid = data.frame(year = seq(1980, 2022, 1)),
                          ice = F,
                          center = F,
                          plot = F,
                          alpha = 1,
                          plot.engine = "ggplot2",
                          train = data_selected %>% 
                            filter(territory == territory_i) %>% 
                            select(-measurementValue, -territory)) %>% 
    mutate(territory = territory_i)
  
  return(results)
  
}

```

# Create function for model

```{r}

xgboost_model <- function(data_selected, bootstrap){
  
  # 2. Split into training and testing datasets----

  train_index <- createDataPartition(data_selected$measurementValue, p = 0.80, 
                                    list = FALSE, 
                                    times = 1)
  
  data_train <- data_selected[train_index,]
  
  data_test <- data_selected[-train_index,]
  
  # 3. Convert to xgboost format ----
  
  data_train_x <- data_train %>% 
    select(-measurementValue, -territory)
  
  data_train_y <- data_train %>% 
    select(measurementValue) %>% 
    pull()
  
  data_test_x <- data_test %>% 
    select(-measurementValue, -territory)
  
  data_test_y <- data_test %>% 
    select(measurementValue) %>% 
    pull()
  
  # 4. Hypertuning ----
  
  # 4.1 Define the training parameters --
  
  xgb_trcontrol = trainControl(method = "cv", number = 5, allowParallel = TRUE,
                               verboseIter = FALSE, returnData = FALSE)
  
  # 4.2 Create the hypergrid --
  
  xgbGrid <- expand.grid(nrounds = 100,  
                         max_depth = c(3, 5, 10),
                         colsample_bytree = seq(0.5, 0.9, length.out = 5),
                         eta = 0.1,
                         gamma = 0,
                         min_child_weight = 1,
                         subsample = 1)
  
  # 4.3 Train the model --
  
  xgb_model <- caret::train(x = data_train_x, y = data_train_y, trControl = xgb_trcontrol, tuneGrid = xgbGrid,
                            method = "xgbTree", weights = data_weight$weight)
  
  # 5. Extract the results
  
  # 5.1 For each territory --
  
  results <- map_dfr(unique(data_selected$territory), ~xgboost_territory(xgb_model, data_selected, territory_i = .))

  # 5.2 For the entire region --
  
  results <- pdp::partial(object = xgb_model,
                          pred.var = "year",
                          pred.grid = data.frame(year = seq(1980, 2022, 1)),
                          ice = F,
                          center = F,
                          plot = F,
                          alpha = 1,
                          plot.engine = "ggplot2",
                          train = data_selected %>% 
                            select(-measurementValue, -territory)) %>% 
    mutate(territory = "Pacific") %>% 
    bind_rows(results) %>% 
    mutate(bootstrap = bootstrap)

  return(results)
  
}

```

# Run the model and export data

## Hard coral cover

```{r}

# 1. Select data for the model --

data_selected <- data_benthic %>% 
  filter(category == "Hard coral") %>% 
  # 1. Make the sum of benthic cover per sampling unit and category
  group_by(datasetID, higherGeography, country, territory, locality, habitat,
           parentEventID, eventID, decimalLatitude, decimalLongitude, verbatimDepth,
           year, month, day, weight) %>% 
  summarise(measurementValue = sum(measurementValue)) %>% 
  ungroup() %>% 
  select(-higherGeography, -country, -locality) %>% 
  # 2. Convert character to numeric
  mutate(territory_num = as.numeric(as.factor(territory)),
         habitat_num = as.numeric(as.factor(habitat)),
         datasetID = as.numeric(datasetID)) %>% 
  select(-habitat)

data_weight <- data_selected %>% select(weight) %>% mutate(weight = replace_na(weight, 0))

data_selected <- data_selected %>% select(-weight)

# 2. Run the model ----

data_results <- map_dfr(seq(1, 100, 1), ~xgboost_model(data_selected, bootstrap = .))

# 3. Export the data ----

write_csv(data_results, file = "../data/11_model-results_hard-coral.csv")

```

## Algae cover

```{r}

# 1. Select data for the model --

data_selected <- data_benthic %>% 
  filter(category == "Algae") %>% 
  # 1. Make the sum of benthic cover per sampling unit and category
  group_by(datasetID, higherGeography, country, territory, locality, habitat,
           parentEventID, eventID, decimalLatitude, decimalLongitude, verbatimDepth,
           year, month, day, weight) %>% 
  summarise(measurementValue = sum(measurementValue)) %>% 
  ungroup() %>% 
  select(-higherGeography, -country, -locality) %>% 
  # 2. Convert character to numeric
  mutate(territory_num = as.numeric(as.factor(territory)),
         habitat_num = as.numeric(as.factor(habitat)),
         datasetID = as.numeric(datasetID)) %>% 
  select(-habitat)

data_weight <- data_selected %>% select(weight) %>% mutate(weight = replace_na(weight, 0))

data_selected <- data_selected %>% select(-weight)

# 2. Run the model ----

data_results <- map_dfr(seq(1, 100, 1), ~xgboost_model(data_selected, bootstrap = .))

# 3. Export the data ----

write_csv(data_results, file = "../data/11_model-results_algae.csv")

```
